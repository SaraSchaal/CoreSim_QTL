---
title: "Process Single Sim File"
author: "Sara Michele Schaal"
date: "2/10/2021"
output: html_document
---

## Load Packages and Upload Data Files ##
```{r}
# load libraries
library(ggplot2)
library(dplyr)
library(purrr)
options(scipen = 999)

# download data
 folder <- "results/Inversion/20201115_FullSet"
 df.params <- read.table("src/InvSimParams.txt", header = TRUE)
 df.invTime <- read.table(paste(folder, "FullSet_invTime.txt", sep = ""), header = TRUE)
 df.invData <- read.table(paste(folder, "FullSet_invData.txt", sep = ""), header = TRUE)
 df.LAallData <- read.table(paste(folder, "FullSet_LAallData.txt", sep = ""), header = TRUE)
 df.LAaveData <- read.table(paste(folder, "FullSet_LAaverage.txt", sep = ""), header = TRUE)
 df.params <- read.table(paste(folder, "invSimParams.txt", sep = ""), header = TRUE)
 unique.params <- read.table(paste(folder, "FullSet_uniqueParams.txt", sep = ""), header = TRUE)
 inv.sims <- subset(unique.params, subset = unique.params$mu_inv > 0)

```

## Merge all dataframes with parameters file
```{r}



```


# Subset for a file that you are interested in
```{r}
# Run subset for either the seed you want or the parameter values
# either this line:
df.singleFile <- subset(df.params, subset = seed == 3383282)
# or this line:
df.singleFile <- subset(df.params, subset = muBase == 1e-7 & muInv == 1e-3 & alpha == 0.002 & sigmaK == 0.75 & 
                                            rep == 1 & enVar == 0, mig1 == 0.25)

```

# Calculate average length, age and size of inversions (EDIT FOR SINGLE FILE)
```{r}

# manipulate data frames for merging
  df.invData$inv_id <- as.numeric(df.invData$inv_id)
  df.invAllData <- merge(df.invData, df.invTimeFreq, by.x = c("seed", "inv_id"), 
                         by.y = c("seed", "inv_id"), all.y = TRUE)
  colnames(df.invAllData)[8] <- "sim_gen"
  df.invAllData$inv_age <- df.invAllData$sim_gen - df.invAllData$inv_originGen

# calculate summary stats on all data (not averaged across reps)
 ave.length.all <- aggregate(inv_length~sim_gen + seed, data = df.invAllData, FUN = mean)
 colnames(ave.length.all)[3] <- "aveLength"
 se.length.all <- aggregate(inv_length~sim_gen + seed, data = df.invAllData, FUN = SE)
 colnames(se.length.all)[3] <- "seLength"
 ave.numQTNs.all <- aggregate(num_qtns~sim_gen + seed, data = df.invAllData, FUN = mean)
 colnames(ave.numQTNs.all)[3] <- "aveQTNs"
 se.numQTNs.all <- aggregate(num_qtns~sim_gen + seed, data = df.invAllData, FUN = SE)
 colnames(se.numQTNs.all)[3] <- "seQTNs"
 ave.age.all <- aggregate(inv_age~sim_gen + seed, data = df.invAllData, FUN = mean)
 colnames(ave.age.all)[3] <- "aveAge"
 se.age.all <- aggregate(inv_age~sim_gen + seed, data = df.invAllData, FUN = SE)
 colnames(se.age.all)[3] <- "seAge"
  
 df.merged <- Reduce(function(x,y) {merge(x = x, y = y, by = c("seed", "sim_gen"))},
                      list(ave.length.all, se.length.all, ave.numQTNs.all, 
                           se.numQTNs.all, ave.age.all, se.age.all))
 
 
# merge parameters and seed then average across replicates
 df.all.data <- merge(df.merged, df.params, by = "seed", all.x = TRUE)
 df.ave.data <- aggregate(cbind(aveLength, aveAge, aveQTNs)~muBase+sigmaK+muInv+alpha+mig1+enVar+sim_gen, 
                          data = df.all.data, FUN = mean)
 
# convert every column of parameters data to factor 
 for(i in 9:ncol(df.all.data)){
    df.all.data[,i] <- as.factor(as.character(df.all.data[,i]))
 }  
  
 for(i in 1:(ncol(df.ave.data)-4)){
   df.ave.data[,i] <- as.factor(as.character(df.ave.data[,i]))
 }
 
```


## Subset inversions by FST values
```{r}
#############################################################################################################
#### Subset Inversions ####
  
## Top 10 percent of FST values
 top10.data <- df.invAllData %>%
    group_by(seed, sim_gen) %>%
    filter(inv_FST>=quantile(inv_FST, 0.9)) %>%
    summarise_at(c("inv_age", "mean_qtnSelCoef", "num_qtns", "inv_length"), 
                 mean, .groups = "keep") %>%
    rename(inv_ageT10 = inv_age, mean_qtnSelCoefT10 = mean_qtnSelCoef, 
           num_qtnsT10 = num_qtns, inv_lengthT10 = inv_length)
  
## Bottom 90 percent of FST values
  bottom90.data <- df.invAllData %>%
    group_by(seed, sim_gen) %>%
    filter(inv_FST<quantile(inv_FST, 0.9)) %>%
    summarise_at(c("inv_age", "mean_qtnSelCoef", "num_qtns", "inv_length"), 
                 mean, .groups = "keep") %>%
    rename(inv_ageB90 = inv_age, mean_qtnSelCoefB90 = mean_qtnSelCoef, 
           numqtnsB90 = num_qtns, inv_lengthB90 = inv_length)
  
## Join dataframes with parameters
  df.FSTsplitTb <- full_join(top10.data, bottom90.data, by = c("seed", "sim_gen"))
  df.FSTsplitTb <- left_join(df.FSTsplitTb, df.params, by = "seed")  
  
## convert to data frame and factor parameter columns
  df.FSTsplit <- as.data.frame(df.FSTsplitTb)
  for(i in 11:(ncol(df.FSTsplit))){
    df.FSTsplit[,i] <- as.factor(as.character(df.FSTsplit[,i]))
  }
  
## get average values across reps
  df.aveFSTsplit <- aggregate(cbind(inv_ageT10, mean_qtnSelCoefT10, num_qtnsT10, 
                                    inv_lengthT10, inv_ageB90, mean_qtnSelCoefB90,
                                    numqtnsB90, inv_lengthB90)~
                                muBase+sigmaK+muInv+alpha+mig1+enVar+sim_gen, data = df.FSTsplit, FUN = mean)
## check size is correct
  length(unique(paste(df.invAllData$seed, df.invAllData$sim_gen)))


```

# Plottiing

## Plotting for Local Adaptation (EDIT FOR SINGLE FILE)
```{r}
library(ggplot2)
inv.labs <- c("0" = "No Inversions", "1e-06" = "Inversion Mu = 1e-06", "0.001" = "Inversion Mu = 1e-3")
df.LA.average$mu_inv <- factor(df.LA.average$mu_inv, levels = c("0","1e-06", "0.001"))
high.alpha <- subset(df.LA.average, subset = alpha == 0.200 & sigmaK == 10.75 & enVar == 0 & mu_base == "1e-07")
low.alpha <- subset(df.LA.average, subset = alpha == 0.002 & sigmaK == 1.5 & enVar == 0 & mu_base == "1e-07")

### Panels are inversion vs. no inversion ###
highSigMu.LAinv <- ggplot(data = high.alpha, 
       aes(x = sim_gen, y = localAdaptSA, group = mig)) + 
       geom_line(aes(color = mig), size = 0.75) + 
       facet_wrap(~mu_inv, labeller = labeller(mu_inv = inv.labs)) + 
       labs(title = "Local Adaptation - hlowsigma_mu (0.200)",
            y = "Local Adaptation",
            x = "Generation") +
 # scale_fill_discrete(names = c("Migration", "QTN Mutation Rate")) +
       guides(color = guide_legend(title = "Migration Rate")) +
             # linetype = guide_legend(title = "QTN Mutation Rate")) +
       theme_classic() +
       theme(panel.background = element_blank(), 
             strip.background = element_rect(colour = "white", fill = "grey92")) +
#  theme(legend.position = "none") +
       scale_color_manual(values=c("darkgrey","cadetblue1","cadetblue3",
                                   "cornflowerblue", "navy","black")) +
       scale_x_continuous(expand = c(0, 0), limits = c(0, NA)) + 
       scale_y_continuous(expand = c(0, 0), limits = c(-0.1, 1))

lowSigMu.LAinv <- ggplot(data = low.alpha, 
       aes(x = sim_gen, y = localAdaptSA, group = mig)) + 
       geom_line(aes(color = mig), size = 0.75) + 
       facet_wrap(~mu_inv, labeller = labeller(mu_inv = inv.labs)) + 
       labs(title = "Local Adaptation - low sigma_mu (0.002)",
            y = "Local Adaptation",
            x = "Generation") +
 # scale_fill_discrete(names = c("Migration", "QTN Mutation Rate")) +
       guides(color = guide_legend(title = "Migration Rate")) +
             # linetype = guide_legend(title = "QTN Mutation Rate")) +
       theme_classic() +
       theme(panel.background = element_blank(), 
             strip.background = element_rect(colour = "white", fill = "grey92")) +
#  theme(legend.position = "none") +
       scale_color_manual(values=c("darkgrey","cadetblue1","cadetblue3", 
                                   "cornflowerblue", "navy", "black")) +
       scale_x_continuous(expand = c(0, 0), limits = c(0, NA)) + 
       scale_y_continuous(expand = c(0, 0), limits = c(-0.1, 1))


```

## Plotting for inversion characteristics (EDIT FOR SINGLE FILE)
```{r}
#############################################################################################################
#### PLOTTING For inversion characteristics ####
#############################################################################################################
  
  ## make labels for facet wrapping
    alpha.labels <- c("0.2" = "sigmaMu = 0.2", "0.002" = "sigmaMu = 0.002")
    mig.labels <- c("0.001" = "mig = 0.001", "0.01" = "mig = 0.01", "0.1" = "mig = 0.1", 
                  "0.25" = "mig = 0.25", "0.4" = "mig = 0.4", "0.5" = "mig = 0.5")


  ## plot inversion age --  split by inversiion FST with reps
    ggplot(data = df.FSTsplit[df.FSTsplit$enVar == 0 & df.FSTsplit$muInv == 0.001 & 
                                df.FSTsplit$sigmaK == 0.75 & df.FSTsplit$alpha == 0.002,], 
           aes(x = sim_gen, y = inv_ageT10, group = interaction(muBase, rep))) + 
           geom_line(aes(color = muBase), size = 0.75, alpha = 0.3) + 
           geom_line(data = df.aveFSTsplit[df.aveFSTsplit$enVar == 0 & df.aveFSTsplit$muInv == 0.001 & 
                                        df.aveFSTsplit$sigmaK == 0.75 & df.aveFSTsplit$alpha == 0.002,], 
                     aes(x = sim_gen, y = inv_ageT10, group = muBase, color = muBase), size = 1.2) + 
           facet_wrap(~ mig1 , labeller = labeller(mig1 = mig.labels), ncol = 6, nrow = 1) + 
           labs(title = "Average Inversions Age Through Time",
                 y = "Average Inversion Age",
                 x = "Generation") +
           guides(color = guide_legend(title = "QTN Mutation Rate")) +
           theme_classic() +
           theme(panel.background = element_blank(), 
                 strip.background = element_rect(colour = "white", fill = "grey92")) +
           scale_color_manual(values=c( "cadetblue3", "navy")) +
           scale_x_continuous(expand = c(0, 0), limits = c(0, NA)) + 
           scale_y_continuous(expand = c(0, 0), limits = c(0, max(df.FSTsplit$inv_ageT10)))
    
  ## plot inversion age -- split by inversion FST just average
    ggplot(data = df.aveFSTsplit[df.aveFSTsplit$enVar == 0 & df.aveFSTsplit$muInv == 0.001 & 
                              df.aveFSTsplit$sigmaK == 0.75 & df.aveFSTsplit$alpha == 0.002,], 
           aes(x = sim_gen, y = inv_ageT10)) + 
      geom_line(aes(color = mig1), size = 0.75, alpha = 0.95) + 
      geom_line(data = df.aveFSTsplit[df.aveFSTsplit$enVar == 0 & df.aveFSTsplit$muInv == 0.001 & 
                                      df.aveFSTsplit$sigmaK == 0.75 & df.aveFSTsplit$alpha == 0.002,], 
                 aes(x = sim_gen, y = inv_ageB90, color = mig1), 
                 size = 0.75, alpha = 0.95, linetype = 3) + 
      facet_wrap(~ muBase + mig1 , labeller = labeller(mig1 = mig.labels), ncol = 6, nrow = 2) + 
      labs(title = "Average Inversions Age Through Time",
           y = "Average Inversion Age",
           x = "Generation") +
      guides(color = guide_legend(title = "Migration Rate")) +
      scale_color_manual(values=c( "darkgrey","cadetblue1","cadetblue3", 
                                   "cornflowerblue", "navy", "black")) +
      theme_classic() +
      theme(panel.background = element_blank(), 
            strip.background = element_rect(colour = "white", fill = "grey92")) +
      scale_x_continuous(expand = c(0, 0), limits = c(0, NA)) + 
      scale_y_continuous(expand = c(0, 0), limits = c(0, max(df.FSTsplit$inv_ageT10)))
    
    ggplot(data = df.aveFSTsplit[df.aveFSTsplit$enVar == 0 & df.aveFSTsplit$muInv == 0.001 & 
                                   df.aveFSTsplit$sigmaK == 0.75 & df.aveFSTsplit$alpha == 0.002,], 
           aes(x = sim_gen, y = inv_ageT10)) + 
      geom_line(aes(color = muBase), size = 0.75, alpha = 0.95) + 
      geom_line(data = df.aveFSTsplit[df.aveFSTsplit$enVar == 0 & df.aveFSTsplit$muInv == 0.001 & 
                                        df.aveFSTsplit$sigmaK == 0.75 & df.aveFSTsplit$alpha == 0.002,], 
                aes(x = sim_gen, y = inv_ageB90, color = muBase), 
                size = 0.75, alpha = 0.95, linetype = 3) + 
      facet_wrap(~ muBase + mig1 , labeller = labeller(mig1 = mig.labels), ncol = 6, nrow = 2) + 
      labs(title = "Average Inversions Age Through Time",
           y = "Average Inversion Age",
           x = "Generation") +
      guides(color= guide_legend(title = "QTN Mutation Rate")) +
      scale_color_manual(values=c( "cadetblue3", "dodgerblue3")) +
      theme_classic() +
      theme(panel.background = element_blank(), 
            strip.background = element_rect(colour = "white", fill = "grey92")) +
      scale_x_continuous(expand = c(0, 0), limits = c(0, NA)) + 
      scale_y_continuous(expand = c(0, 0), limits = c(0, max(df.aveFSTsplit$inv_ageT10)))
   
  ## plot all data         
    inv.Age <-  ggplot(data = df.all.data[df.all.data$enVar == 0 & df.all.data$muInv == 0.001 &
                                          df.all.data$sigmaK == 0.75 & df.all.data$alpha == 0.002,], 
                       aes(x = sim_gen, y = aveAge, group = interaction(muBase, rep))) + 
      geom_line(aes(color = muBase), size = 0.75, alpha = 0.3) + 
      geom_line(data = df.ave.data[df.ave.data$enVar == 0 & df.ave.data$muInv == 0.001 & 
                                   df.ave.data$sigmaK == 0.75 & df.ave.data$alpha == 0.002,], 
                aes(x = sim_gen, y = aveAge, group = muBase, color = muBase), 
              size = 1.2) + 
      facet_wrap(~ mig1 , labeller = labeller(mig1 = mig.labels),
                 ncol = 6, nrow = 1) + 
      labs(title = "Average Inversions Age Through Time",
           y = "Average Inversion Age",
           x = "Generation") +
      guides(color = guide_legend(title = "QTN Mutation Rate")) +
      theme_classic() +
      theme(panel.background = element_blank(), 
            strip.background = element_rect(colour = "white", fill = "grey92")) +
      scale_color_manual(values=c( "cadetblue3", "navy")) +
      scale_x_continuous(expand = c(0, 0), limits = c(0, NA)) + 
      scale_y_continuous(expand = c(0, 0), limits = c(0, max(df.ave.data$aveAge)))
    
 ### Inversion Length ####
 #######################################
    
    inv.Length <- ggplot(data = df.all.data[df.all.data$enVar == 0 & df.all.data$muInv == 0.001 &
                                               df.all.data$sigmaK == 0.75 & df.all.data$alpha == 0.002,], 
                          aes(x = sim_gen, y = aveLength, group = interaction(muBase, rep))) + 
      geom_line(aes(color = muBase), size = 0.75, alpha = 0.3) + 
      geom_line(data = df.ave.data[df.ave.data$enVar == 0 & df.ave.data$muInv == 0.001 &
                                     df.ave.data$sigmaK == 0.75 & df.ave.data$alpha == 0.002,], 
                aes(x = sim_gen, y = aveLength, group = interaction(muBase), color = muBase), size = 1.2) + 
      facet_wrap(~ mig1 , labeller = labeller(mig1 = mig.labels),
                 ncol = 6, nrow = 1) + 
      labs(title = "Average Inversion Length Through Time",
           y = "Average Inversion Length",
           x = "Generation") +
      guides(color = guide_legend(title = "QTN Mutation Rate")) +
          #   linetype = guide_legend(title = "Sigma Mu (Effect Size)")) +
      theme_classic() +
      theme(panel.background = element_blank(), 
            strip.background = element_rect(colour = "white", fill = "grey92")) +
      scale_color_manual(values=c( "cadetblue3", "navy")) +
      scale_x_continuous(expand = c(0, 0), limits = c(0, NA)) + 
      scale_y_continuous(expand = c(0, 0), limits = c(0, max(df.ave.data$aveLength)))
    
    ## plot inversion length -- split by inversion FST just average
    ggplot(data = df.aveFSTsplit[df.aveFSTsplit$enVar == 0 & df.aveFSTsplit$muInv == 0.001 & 
                                   df.aveFSTsplit$sigmaK == 0.75 & df.aveFSTsplit$alpha == 0.002,], 
           aes(x = sim_gen, y = inv_lengthT10)) + 
      geom_line(aes(color = mig1), size = 0.75, alpha = 0.95) + 
      geom_line(data = df.aveFSTsplit[df.aveFSTsplit$enVar == 0 & df.aveFSTsplit$muInv == 0.001 & 
                                        df.aveFSTsplit$sigmaK == 0.75 & df.aveFSTsplit$alpha == 0.002,], 
                aes(x = sim_gen, y = inv_lengthB90, color = mig1), 
                size = 0.75, alpha = 0.95, linetype = 3) + 
      facet_wrap(~muBase + mig1, labeller = labeller(mig1 = mig.labels), ncol = 6, nrow = 2) + 
      labs(title = "Average Inversions Length Through Time",
           y = "Average Inversion Length",
           x = "Generation") +
      guides(color = guide_legend(title = "Migration Rate")) +
      scale_color_manual(values=c( "darkgrey","cadetblue1","cadetblue3", 
                                   "cornflowerblue", "navy", "black")) +
      theme_classic() +
      theme(panel.background = element_blank(), 
            strip.background = element_rect(colour = "white", fill = "grey92")) +
      scale_x_continuous(expand = c(0, 0), limits = c(0, NA)) + 
      scale_y_continuous(expand = c(0, 0), limits = c(0, max(df.FSTsplit$inv_lengthT10)))
    
    
    ggplot(data = df.aveFSTsplit[df.aveFSTsplit$enVar == 0 & df.aveFSTsplit$muInv == 0.001 & 
                                   df.aveFSTsplit$sigmaK == 0.75 & df.aveFSTsplit$alpha == 0.002,], 
           aes(x = sim_gen, y = num_qtnsT10)) + 
      geom_line(aes(color = mig1), size = 0.75, alpha = 0.95) + 
      geom_line(data = df.aveFSTsplit[df.aveFSTsplit$enVar == 0 & df.aveFSTsplit$muInv == 0.001 & 
                                        df.aveFSTsplit$sigmaK == 0.75 & df.aveFSTsplit$alpha == 0.002,], 
                aes(x = sim_gen, y = numqtnsB90, color = mig1), 
                size = 0.75, alpha = 0.95, linetype = 3) + 
      facet_wrap(~muBase + mig1, labeller = labeller(mig1 = mig.labels), ncol = 6, nrow = 2) + 
      labs(title = "Average Number of Inversion QTNs Through Time",
           y = "Average Number of Inversion QTNs",
           x = "Generation") +
      guides(color = guide_legend(title = "Migration Rate")) +
      scale_color_manual(values=c( "darkgrey","cadetblue1","cadetblue3", 
                                   "cornflowerblue", "navy", "black")) +
      theme_classic() +
      theme(panel.background = element_blank(), 
            strip.background = element_rect(colour = "white", fill = "grey92")) +
      scale_x_continuous(expand = c(0, 0), limits = c(0, NA)) + 
      scale_y_continuous(expand = c(0, 0), limits = c(0, 300))
   
### Inversion QTNs ####
#######################################   
    
inv.numQTNs <-  ggplot(data = df.all.data[df.all.data$enVar == 0 & df.all.data$muInv == 0.001,], 
                          aes(x = sim_gen, y = aveQTNs, group = interaction(muBase, alpha, rep))) + 
      geom_line(aes(color = muBase, linetype = alpha), size = 0.75, alpha = 0.3) + 
      geom_line(data = df.ave.data[df.ave.data$enVar == 0 & df.ave.data$muInv == 0.001,], 
                aes(x = sim_gen, y = aveQTNs, group = interaction(muBase, alpha), linetype = alpha, color = muBase), size = 1.2) + 
      facet_wrap(~ sigmaK + mig1 , labeller = labeller(mig1 = mig.labels),
                 ncol = 6, nrow = 3) + 
      labs(title = "Average Number of Inversion QTNs Through Time",
           y = "Average Number of Inversion QTNs",
           x = "Generation") +
      guides(color = guide_legend(title = "QTN Mutation Rate"), 
             linetype = guide_legend(title = "Sigma Mu (Effect Size)")) +
      theme_classic() +
      theme(panel.background = element_blank(), 
            strip.background = element_rect(colour = "white", fill = "grey92")) +
      scale_color_manual(values=c( "cadetblue3", "navy")) +
      scale_x_continuous(expand = c(0, 0), limits = c(0, NA)) + 
      scale_y_continuous(expand = c(0, 0), limits = c(0, max(df.ave.data$aveQTNs)))
    


```